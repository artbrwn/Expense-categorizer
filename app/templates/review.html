{% extends "base.html" %}

{% block title %}Review - Expense Categorizer{% endblock %}

{% block content %}
<style>
    .uncategorized {
        color: red;
    }
    .transaction-row {
        /* Todas las filas inicialmente visibles, JS las ocultar√° */
    }
    .pagination-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
        padding: 10px;
        background-color: #f0f0f0;
        border-radius: 5px;
    }
    .pagination-controls button {
        padding: 8px 16px;
        cursor: pointer;
    }
    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

<div class="session-info">
    <p>üìÅ Editando: <strong>{{ file_path }}</strong></p>
    <p>Total de transacciones: <strong id="total-transactions">{{ transactions|length }}</strong></p>
</div>

<h2>Revisi√≥n de transacciones</h2>

<!-- Controles de paginaci√≥n superiores -->
<div class="pagination-controls">
    <button id="prev-btn" onclick="previousPage()">‚Üê Anterior</button>
    <span>
        P√°gina <span id="current-page">1</span> de <span id="total-pages">1</span>
        (Mostrando <span id="showing-count">0</span> transacciones)
    </span>
    <button id="next-btn" onclick="nextPage()">Siguiente ‚Üí</button>
</div>

<form action="/review?file={{ file_path }}" method="POST" id="review-form">
  <table data-theme="light">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Descripci√≥n</th>
        <th>Cantidad (‚Ç¨)</th>
        <th>Categor√≠a</th>
      </tr>
    </thead>
    <tbody id="transactions-tbody">
      {% for transaction in transactions %}
      <tr class="transaction-row
        {% if transaction['category'] == 'uncategorized' %}
          uncategorized
        {% elif transaction['amount']|float < 0 %}
          gasto
        {% else %}
          ingreso
        {% endif %}
      " data-index="{{ loop.index0 }}">
        <td>
          {{transaction['date']}}
          <input type="hidden" name="date-{{transaction['id']}}" value="{{transaction['date']}}">
          <input type="hidden" name="id-{{transaction['id']}}" value="{{transaction['id']}}">
        </td>
        <td>
          <input type="text" value="{{transaction['description']}}" disabled>
          <input type="hidden" name="description-{{transaction['id']}}" value="{{transaction['description']}}">
        </td>
        <td>
          <input type="number" step="0.01" name="amount-{{transaction['id']}}" value="{{transaction['amount']}}">
        </td>
        <td>
          <select name="category-{{transaction['id']}}">
            {% for category in categories %}
              <option value="{{category}}" {% if transaction['category'] == category %}selected{% endif %}>{{category}}</option>
            {% endfor %}
          </select>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div style="margin-top: 20px;">
    <button type="submit">üíæ Guardar todas las transacciones</button>
  </div>
</form>

<!-- Controles de paginaci√≥n inferiores -->
<div class="pagination-controls">
    <button id="prev-btn-bottom" onclick="previousPage()">‚Üê Anterior</button>
    <span>
        P√°gina <span id="current-page-bottom">1</span> de <span id="total-pages-bottom">1</span>
    </span>
    <button id="next-btn-bottom" onclick="nextPage()">Siguiente ‚Üí</button>
</div>

<script>
    // Configuraci√≥n
    const ITEMS_PER_PAGE = 50;
    let currentPage = 1;
    
    // Obtener todas las filas
    const allRows = document.querySelectorAll('.transaction-row');
    const totalItems = allRows.length;
    const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
    
    // Inicializar
    function init() {
        updatePageInfo();
        showPage(currentPage);
    }
    
    // Mostrar p√°gina espec√≠fica
    function showPage(pageNumber) {
        const start = (pageNumber - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        
        allRows.forEach((row, index) => {
            if (index >= start && index < end) {
                row.style.display = '';  // Mostrar
            } else {
                row.style.display = 'none';  // Ocultar
            }
        });
        
        updatePageInfo();
        updateButtons();
        scrollToTop();
    }
    
    // Actualizar informaci√≥n de p√°gina
    function updatePageInfo() {
        const start = (currentPage - 1) * ITEMS_PER_PAGE + 1;
        const end = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
        const showing = end - start + 1;
        
        // Actualizar todos los elementos de informaci√≥n
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('current-page-bottom').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;
        document.getElementById('total-pages-bottom').textContent = totalPages;
        document.getElementById('showing-count').textContent = showing;
    }
    
    // Actualizar estado de botones
    function updateButtons() {
        const prevBtns = [
            document.getElementById('prev-btn'),
            document.getElementById('prev-btn-bottom')
        ];
        const nextBtns = [
            document.getElementById('next-btn'),
            document.getElementById('next-btn-bottom')
        ];
        
        // Botones anteriores
        prevBtns.forEach(btn => {
            btn.disabled = currentPage === 1;
        });
        
        // Botones siguientes
        nextBtns.forEach(btn => {
            btn.disabled = currentPage === totalPages;
        });
    }
    
    // Navegar a p√°gina anterior
    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            showPage(currentPage);
        }
    }
    
    // Navegar a p√°gina siguiente
    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            showPage(currentPage);
        }
    }
    
    // Scroll al inicio de la tabla
    function scrollToTop() {
        document.querySelector('h2').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Opcional: Navegar con teclado
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                previousPage();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextPage();
            }
        }
    });
    
    // Inicializar al cargar la p√°gina
    init();
</script>

<!-- Volver al selector -->
<a href="/review/select" style="margin-top: 20px; display: inline-block;">
    ‚Üê Volver a la lista de archivos
</a>

{% endblock %}